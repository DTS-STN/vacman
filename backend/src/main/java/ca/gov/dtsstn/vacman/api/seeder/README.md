# VacMan Database Seeder

This package contains a robust and configurable database seeding system for the VacMan application. The seeder creates realistic test data with proper relationships for development and testing purposes.

## Architecture

### Core Components

1. **DatabaseSeeder** - Main orchestrator that coordinates the seeding process
2. **DatabaseSeederStartupListener** - Triggers seeding on application startup
3. **DatabaseSeederConfig** - Configuration properties for all seeding options
4. **MainDataSeeder** - Seeds primary entities (Users, Profiles, Requests)
5. **JunctionDataSeeder** - Seeds relationship/junction tables
6. **LookupDataSeeder** - Legacy lookup data seeder (deprecated - use data.sql)

### Data Source Strategy

The seeder follows a **data.sql-first approach**:

- **Lookup data**: Sourced from `src/main/resources/data.sql` (provinces, cities, classifications, etc.)
- **Main entities**: Generated by Java seeders with realistic distributions
- **Relationships**: Created by junction seeders with configurable constraints

The seeder verifies that lookup data exists before creating main entities, ensuring referential integrity. If lookup data is missing, seeding will fail with a clear error message.

## Configuration

### Profile-Specific Configuration

The seeder is configured via application YAML files with environment-specific settings:

- `application-dev.yaml` - Development environment (25 users, 20 profiles, 15 requests)
- `application-local.yaml` - Local development (12 users, 22 profiles, 8 requests)
- `application-h2.yaml` - H2 database testing (10 users, 10 profiles, 5 requests)

### Key Configuration Options

All seeder configuration is defined under the `app.database.seeder` prefix. Below are the most commonly used configuration options:

```yaml
app:
  database:
    seeder:
      # Basic control settings
      enabled: true                   # Enable/disable seeding
      seedLookupTables: false         # Use data.sql instead for lookup data
      seedJunctionTables: true        # Create entity relationships
      clearDataFirst: true            # Clear existing data before seeding
      skipIfDataExists: true          # Skip seeding if data already exists

      # Entity counts (environment-specific)
      userCount: 25                   # Number of users to create
      profileCount: 20                # Number of profiles to create
      requestCount: 15                # Number of requests to create

      # User type distribution (must sum to 1.0)
      adminUserPercentage: 0.08       # 8% administrators
      hiringManagerPercentage: 0.32   # 32% hiring managers
      employeeUserPercentage: 0.60    # 60% regular employees

      # Request status distribution (must sum to 1.0)
      draftRequestPercentage: 0.25    # 25% draft requests
      submittedRequestPercentage: 0.30    # 30% submitted
      underReviewRequestPercentage: 0.20  # 20% under review
      approvedRequestPercentage: 0.15     # 15% approved
      rejectedRequestPercentage: 0.10     # 10% rejected

      # Profile status distribution (must sum to 1.0)
      activeProfilePercentage: 0.75   # 75% active profiles
      inactiveProfilePercentage: 0.15 # 15% inactive
      pendingProfilePercentage: 0.10  # 10% pending

      # Relationship cardinality constraints
      minCitiesPerProfile: 1
      maxCitiesPerProfile: 3
      minClassificationsPerProfile: 1
      maxClassificationsPerProfile: 2
      minEmploymentEquitiesPerRequest: 0
      maxEmploymentEquitiesPerRequest: 2

      # Data quality and consistency
      useFixedSeed: true              # Reproducible random data
      randomSeed: 42                  # Seed value for reproducibility
      logSeedingProgress: true        # Enable detailed logging
      validateRelationships: true     # Validate created relationships
      ensureDataConsistency: true     # Ensure data integrity
      validateForeignKeys: true       # Validate foreign key relationships
      batchSize: 50                   # Batch size for bulk operations
```

**Note**: For a complete list of all available configuration options, see the `DatabaseSeederConfig.java` class, which contains additional advanced settings for fine-tuning the seeding behavior.

## Features

### Realistic Data Generation

- **Names**: Uses pools of realistic first and last names
- **Email addresses**: Generated with unique patterns (firstname.lastname{n}@example.com)
- **Distributions**: Configurable percentages for user types, request statuses, profile statuses
- **Relationships**: Proper foreign key relationships with configurable cardinalities

### Data Integrity

- **Validation**: Configuration validation before seeding
- **Foreign Key Checks**: Ensures lookup data exists before creating main entities
- **Relationship Validation**: Post-seeding validation of created relationships
- **Transaction Safety**: All operations are transactional

### Performance Optimization

- **Lookup Caching**: Lookup data is cached for better performance
- **Batch Operations**: Configurable batch sizes for bulk inserts
- **Skip Logic**: Intelligent skipping of existing data
- **Fixed Seeds**: Reproducible random data generation

## Usage

### Running the Seeder

The seeder runs automatically on application startup via the `DatabaseSeederStartupListener` for these profiles:

- `dev`
- `local`
- `h2`

To control seeding behavior:

```yaml
# Disable seeding
app.database.seeder.enabled: false

# Clear and reseed
app.database.seeder.clearDataFirst: true
app.database.seeder.skipIfDataExists: false

# Seed only if empty
app.database.seeder.clearDataFirst: false
app.database.seeder.skipIfDataExists: true
```

### Manual Execution

The seeder can be triggered programmatically by autowiring the `DatabaseSeeder`:

```java
@Autowired
private DatabaseSeeder seeder;

public void reseedDatabase() {
    try {
        seeder.run();
    } catch (Exception e) {
        logger.error("Manual seeding failed", e);
    }
}
```

## Generated Data

### Users

- **Count**: Configurable (default: 25 for dev, 12 for local, 10 for h2)
- **Types**: Admin (8-10%), Hiring Manager (30-32%), Employee (60%)
- **Languages**: Randomly assigned from available languages
- **Attributes**: Unique emails, realistic names, proper foreign keys

### Profiles

- **Count**: Configurable (default: 20 for dev, 22 for local, 10 for h2)
- **Status**: Active (75%), Inactive (15%), Pending (10%)
- **Classification**: Randomly assigned from available classifications
- **Work Unit**: Randomly assigned from available work units
- **HR Advisor**: Attempts to assign hiring managers as HR advisors

### Requests

- **Count**: Configurable (default: 15 for dev, 8 for local, 5 for h2)
- **Status**: Draft (25-30%), Submitted (30%), Under Review (20%), Approved (10-15%), Rejected (10%)
- **Creators**: Randomly assigned from existing users
- **Priority**: Randomly assigned priority levels

### Relationships

- **City-Profile**: 1-3 cities per profile (configurable)
- **Classification-Profile**: 1-2 classifications per profile (configurable)
- **Employment Opportunities**: 1-3 per profile (configurable)
- **Language Referral Types**: 1-2 per profile (configurable)
- **Request-City**: 1-4 cities per request (configurable)
- **Request-Employment Equity**: 0-2 equity groups per request (configurable)

## Troubleshooting

### Common Issues

1. **Missing Lookup Data**

   ```text
   Error: Required lookup data not found. Ensure data.sql has been loaded.
   ```

   - Solution: Ensure `data.sql` is in `src/main/resources` and `spring.jpa.defer-datasource-initialization: true`

2. **Configuration Validation Errors**

   ```text
   Error: User type percentages must sum to 1.0
   ```

   - Solution: Verify all percentage configurations sum to exactly 1.0

3. **Foreign Key Violations**

   ```text
   Error: Cannot create profile without valid user
   ```

   - Solution: Check that main entities are seeded before relationships

4. **Profile Configuration Issues**
   - Issue: Seeder not running in expected environment
   - Solution: Verify the correct Spring profile is active (`dev`, `local`, or `h2`) and `app.database.seeder.enabled: true`

### Debugging

Enable detailed logging:

```yaml
app:
  database:
    seeder:
      logSeedingProgress: true
      validateRelationships: true
      validateForeignKeys: true
```

## Best Practices

1. **Use fixed seeds for reproducible data**:

   ```yaml
   useFixedSeed: true
   randomSeed: 42  # Or any consistent value
   ```

2. **Configure appropriate data volumes**:
   - Local development: 8-12 records per entity (current local default)
   - Development environment: 15-25 records per entity (current dev default)
   - Integration testing: Use h2 profile with 5-10 records per entity
   - Performance testing: Scale up entity counts appropriately

3. **Maintain realistic distributions**:
   - Follow organizational hierarchy patterns
   - Use government-appropriate classification distributions
   - Maintain realistic workflow state percentages

4. **Keep lookup data in data.sql**:
   - Don't modify lookup data via Java seeders
   - Use data.sql as the authoritative source
   - Let seeders focus on business entities and relationships

## Extending the Seeder

### Adding New Entities

1. Create entity-specific seeding methods in `MainDataSeeder`
2. Add configuration options to `DatabaseSeederConfig`
3. Update `seedMainData()` to call new seeding methods
4. Add relationship seeding to `JunctionDataSeeder` if needed

### Adding New Relationships

1. Add seeding method to `JunctionDataSeeder`
2. Add configuration for relationship cardinality
3. Update `seedJunctionData()` to call new method
4. Add proper cleanup in `clearJunctionData()`

### Custom Data Patterns

Override seeding methods to implement custom business logic:

```java
@Component
@Profile("custom")
public class CustomMainDataSeeder extends MainDataSeeder {

    @Override
    protected UserEntity createUser(String email, String firstName, String lastName,
                                  UserTypeEntity userType, LanguageEntity language) {
        // Custom user creation logic
        return super.createUser(email, firstName, lastName, userType, language);
    }
}
```
