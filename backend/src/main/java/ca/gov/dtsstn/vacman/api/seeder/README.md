# VacMan Database Seeder

This package contains a robust and configurable database seeding system for the VacMan application. The seeder creates realistic test data with proper relationships for development and testing purposes.

## Architecture

### Core Components

1. **DatabaseSeeder** - Main orchestrator that coordinates the seeding process
2. **DatabaseSeederConfig** - Configuration properties for all seeding options
3. **MainDataSeeder** - Seeds primary entities (Users, Profiles, Requests)
4. **JunctionDataSeeder** - Seeds relationship/junction tables
5. **LookupDataSeeder** - Seeds lookup/reference data (deprecated - use data.sql)

### Data Source Strategy

The seeder follows a **data.sql-first approach**:
- **Lookup data**: Sourced from `src/main/resources/data.sql` (provinces, cities, classifications, etc.)
- **Main entities**: Generated by Java seeders with realistic distributions
- **Relationships**: Created by junction seeders with configurable constraints

## Configuration

### Profile-Specific Configuration

The seeder is configured via application YAML files:

- `application-dev.yaml` - Development environment (larger datasets)
- `application-local.yaml` - Local development (smaller datasets)
- `application-h2.yaml` - H2 database testing

### Key Configuration Options

```yaml
app:
  database:
    seeder:
      # Basic settings
      enabled: true
      seedLookupTables: false      # Use data.sql instead
      seedJunctionTables: true     # Create relationships
      clearDataFirst: true         # Clear before seeding
      skipIfDataExists: true       # Don't reseed existing data

      # Entity counts
      userCount: 25
      profileCount: 20
      requestCount: 15

      # Distribution percentages (must sum to 1.0)
      adminUserPercentage: 0.08
      hiringManagerPercentage: 0.32
      employeeUserPercentage: 0.60

      # Relationship constraints
      minCitiesPerProfile: 1
      maxCitiesPerProfile: 3
      minEmploymentEquitiesPerRequest: 0
      maxEmploymentEquitiesPerRequest: 2
```

## Features

### Realistic Data Generation

- **Names**: Uses pools of realistic first and last names
- **Email addresses**: Generated with unique patterns (firstname.lastname{n}@example.com)
- **Distributions**: Configurable percentages for user types, request statuses, profile statuses
- **Relationships**: Proper foreign key relationships with configurable cardinalities

### Data Integrity

- **Validation**: Configuration validation before seeding
- **Foreign Key Checks**: Ensures lookup data exists before creating main entities
- **Relationship Validation**: Post-seeding validation of created relationships
- **Transaction Safety**: All operations are transactional

### Performance Optimization

- **Lookup Caching**: Lookup data is cached for better performance
- **Batch Operations**: Configurable batch sizes for bulk inserts
- **Skip Logic**: Intelligent skipping of existing data
- **Fixed Seeds**: Reproducible random data generation

## Usage

### Running the Seeder

The seeder runs automatically on application startup for these profiles:
- `dev`
- `local`
- `h2`

To control seeding behavior:

```yaml
# Disable seeding
app.database.seeder.enabled: false

# Clear and reseed
app.database.seeder.clearDataFirst: true
app.database.seeder.skipIfDataExists: false

# Seed only if empty
app.database.seeder.clearDataFirst: false
app.database.seeder.skipIfDataExists: true
```

### Manual Execution

The seeder can be triggered programmatically:

```java
@Autowired
private DatabaseSeeder seeder;

public void reseedDatabase() {
    seeder.run();
}
```

## Generated Data

### Users
- **Count**: Configurable (default: 25 for dev, 12 for local)
- **Types**: Admin (8%), Hiring Manager (32%), Employee (60%)
- **Languages**: Randomly assigned from available languages
- **Attributes**: Unique emails, realistic names, proper foreign keys

### Profiles
- **Count**: Configurable (default: 20 for dev, 15 for local)
- **Status**: Active (75%), Inactive (15%), Pending (10%)
- **Classification**: Randomly assigned from available classifications
- **Work Unit**: Randomly assigned from available work units
- **HR Advisor**: Attempts to assign hiring managers as HR advisors

### Requests
- **Count**: Configurable (default: 15 for dev, 8 for local)
- **Status**: Draft (25%), Submitted (30%), Under Review (20%), Approved (15%), Rejected (10%)
- **Creators**: Randomly assigned from existing users
- **Priority**: Randomly assigned priority levels

### Relationships
- **City-Profile**: 1-3 cities per profile
- **Classification-Profile**: 1-2 classifications per profile
- **Employment Opportunities**: 1-3 per profile
- **Language Referral Types**: 1-2 per profile
- **Request-City**: 1-4 cities per request
- **Request-Employment Equity**: 0-2 equity groups per request

## Troubleshooting

### Common Issues

1. **Missing Lookup Data**
   ```
   Error: Required lookup data not found. Ensure data.sql has been loaded.
   ```
   - Solution: Ensure `data.sql` is in `src/main/resources` and `spring.jpa.defer-datasource-initialization: true`

2. **Configuration Validation Errors**
   ```
   Error: User type percentages must sum to 1.0
   ```
   - Solution: Verify all percentage configurations sum to exactly 1.0

3. **Foreign Key Violations**
   ```
   Error: Cannot create profile without valid user
   ```
   - Solution: Check that main entities are seeded before relationships

### Debugging

Enable detailed logging:

```yaml
app:
  database:
    seeder:
      logSeedingProgress: true
      validateRelationships: true
      validateForeignKeys: true
```

## Best Practices

1. **Use fixed seeds for reproducible data**:
   ```yaml
   useFixedSeed: true
   randomSeed: 42
   ```

2. **Configure appropriate data volumes**:
   - Local development: 10-15 records per entity
   - Integration testing: 20-30 records per entity
   - Performance testing: Scale appropriately

3. **Maintain realistic distributions**:
   - Follow organizational hierarchy patterns
   - Use government-appropriate classification distributions
   - Maintain realistic workflow state percentages

4. **Keep lookup data in data.sql**:
   - Don't modify lookup data via Java seeders
   - Use data.sql as the authoritative source
   - Let seeders focus on business entities and relationships

## Extending the Seeder

### Adding New Entities

1. Create entity-specific seeding methods in `MainDataSeeder`
2. Add configuration options to `DatabaseSeederConfig`
3. Update `seedMainData()` to call new seeding methods
4. Add relationship seeding to `JunctionDataSeeder` if needed

### Adding New Relationships

1. Add seeding method to `JunctionDataSeeder`
2. Add configuration for relationship cardinality
3. Update `seedJunctionData()` to call new method
4. Add proper cleanup in `clearJunctionData()`

### Custom Data Patterns

Override seeding methods to implement custom business logic:

```java
@Component
@Profile("custom")
public class CustomMainDataSeeder extends MainDataSeeder {

    @Override
    protected UserEntity createUser(String email, String firstName, String lastName,
                                  UserTypeEntity userType, LanguageEntity language) {
        // Custom user creation logic
        return super.createUser(email, firstName, lastName, userType, language);
    }
}
```
